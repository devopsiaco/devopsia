<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>User Account — Devopsia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/css/style.css" rel="stylesheet" />
  <style>
    .card { background: #fff; border: 1px solid #eee; border-radius: 1rem; padding: 1rem; }
    .grid { display: grid; gap: 1rem; grid-template-columns: 1fr; }
    @media (min-width: 768px) { .grid { grid-template-columns: 1fr 1fr; } }
    .btn { padding: .6rem .9rem; border-radius: .75rem; }
    .btn-primary { background: #111827; color: #fff; }
    .btn-ghost { background: #f3f4f6; }
    .danger { color: #b91c1c; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-700">
  <div class="flex">
    <div id="sidebar-container" class="hidden md:block"></div>
    <main class="flex-1 p-4 md:p-8 max-w-5xl">
      <h1 class="text-2xl font-semibold mb-4">User Account</h1>
      <p class="text-sm text-gray-600 mb-6">Manage your profile, password, and subscription.</p>
      <div class="grid">
        <!-- Profile & Avatar -->
        <section class="card">
          <h2 class="font-medium mb-3">Profile</h2>
          <div class="flex items-center gap-4">
            <img id="ua-avatar-preview" class="w-20 h-20 rounded-full object-cover border" src="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27128%27%20height%3D%27128%27%20viewBox%3D%270%200%20128%20128%27%3E%3Crect%20width%3D%27128%27%20height%3D%27128%27%20fill%3D%27%23e5e7eb%27/%3E%3C/svg%3E" alt="Avatar">
            <div>
              <div class="text-sm text-gray-500">Email</div>
              <div id="ua-email" class="font-medium">—</div>
              <div class="text-sm text-gray-500 mt-2">Plan</div>
              <div id="ua-plan" class="font-medium">—</div>
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm mb-1">Upload new avatar</label>
            <input id="ua-avatar-file" type="file" accept="image/*" />
            <div class="text-xs text-gray-500 mt-1">PNG/JPG, max ~2MB recommended.</div>
            <button id="ua-save-avatar" class="btn btn-primary mt-3">Save Avatar</button>
            <div id="ua-avatar-msg" class="text-sm mt-2"></div>
          </div>
        </section>
        <!-- Password -->
        <section class="card">
          <h2 class="font-medium mb-3">Password</h2>
          <p class="text-sm text-gray-600 mb-3">You can change your password securely.</p>
          <div class="flex gap-2">
            <input id="ua-new-pass" type="password" class="flex-1 border rounded-lg px-3 py-2" placeholder="New password (min 8 chars)" />
            <button id="ua-change-pass" class="btn btn-primary">Change</button>
          </div>
          <div class="text-sm text-gray-500 mt-2">
            Or <button id="ua-send-reset" class="underline">send a password reset email</button>.
          </div>
          <div id="ua-pass-msg" class="text-sm mt-2"></div>
        </section>
        <!-- Subscription -->
        <section class="card">
          <h2 class="font-medium mb-3">Subscription</h2>
          <p class="text-sm text-gray-600 mb-3">Manage or cancel your plan via Stripe Customer Portal.</p>
          <button id="ua-manage-sub" class="btn btn-ghost">Open Billing Portal</button>
          <div id="ua-sub-msg" class="text-sm mt-2"></div>
        </section>
        <!-- Danger Zone (optional) -->
        <section class="card">
          <h2 class="font-medium mb-3 danger">Danger Zone</h2>
          <p class="text-sm text-gray-600">Sign out from this device.</p>
          <button id="ua-signout" class="btn btn-ghost">Sign out</button>
        </section>
      </div>
    </main>
  </div>
  <!-- Firebase -->
  <script type="module" src="/js/firebase.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-storage.js"></script>
  <script> if (!firebase.apps.length) firebase.initializeApp(window.firebaseConfig); </script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/sidebar-loader.js"></script>
  <script type="module">
    import { requireAuth, getCurrentUserOnce } from '/js/auth.js';
    import { loadSidebar } from '/js/sidebar-loader.js';
    // Guard page
    await requireAuth({ mustBeVerified: true }).catch(() => {});
    loadSidebar('user-account');
    const emailEl = document.getElementById('ua-email');
    const planEl  = document.getElementById('ua-plan');
    const avatarPreview = document.getElementById('ua-avatar-preview');
    const user = await getCurrentUserOnce();
    if (user) emailEl.textContent = user.email || '—';
    const db = firebase.firestore();
    const storage = firebase.storage();
    // Load plan + avatar
    try {
      const doc = await db.collection('users').doc(user.uid).get();
      const data = doc.exists ? doc.data() : {};
      planEl.textContent = data?.plan || 'Free';
      if (data?.avatarUrl) avatarPreview.src = data.avatarUrl;
    } catch (e) { console.warn(e); }
    // Save avatar
    document.getElementById('ua-save-avatar').addEventListener('click', async () => {
      const file = document.getElementById('ua-avatar-file').files?.[0];
      const msg = document.getElementById('ua-avatar-msg');
      if (!file) { msg.textContent = 'Please choose an image file.'; return; }
      try {
        const path = `avatars/${user.uid}/${Date.now()}-${file.name}`;
        const ref = storage.ref().child(path);
        await ref.put(file, { contentType: file.type });
        const url = await ref.getDownloadURL();
        await db.collection('users').doc(user.uid).set({ avatarUrl: url }, { merge: true });
        avatarPreview.src = url;
        msg.textContent = 'Avatar updated ✅';
      } catch (e) {
        console.error(e);
        msg.textContent = 'Failed to upload avatar.';
      }
    });
    // Change password
    document.getElementById('ua-change-pass').addEventListener('click', async () => {
      const newPass = document.getElementById('ua-new-pass').value;
      const msg = document.getElementById('ua-pass-msg');
      msg.textContent = '';
      if (!newPass || newPass.length < 8) { msg.textContent = 'Use at least 8 characters.'; return; }
      try {
        await user.updatePassword(newPass);
        msg.textContent = 'Password changed ✅';
        document.getElementById('ua-new-pass').value = '';
      } catch (e) {
        console.error(e);
        // If recent login required:
        if (e?.code === 'auth/requires-recent-login') {
          msg.textContent = 'Please re-login, then try again.';
        } else {
          msg.textContent = 'Failed to change password.';
        }
      }
    });
    // Send reset email
    document.getElementById('ua-send-reset').addEventListener('click', async () => {
      const msg = document.getElementById('ua-pass-msg');
      try {
        await firebase.auth().sendPasswordResetEmail(user.email);
        msg.textContent = 'Password reset email sent.';
      } catch (e) {
        console.error(e);
        msg.textContent = 'Failed to send reset email.';
      }
    });
    // Manage subscription (Stripe Portal)
    document.getElementById('ua-manage-sub').addEventListener('click', async () => {
      const msg = document.getElementById('ua-sub-msg');
      msg.textContent = 'Opening billing portal...';
      try {
        const res = await fetch('https://api.devopsia.co/create-customer-portal-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uid: user.uid })
        });
        if (!res.ok) throw new Error('Portal request failed');
        const data = await res.json();
        if (data?.url) {
          window.location.href = data.url;
        } else {
          throw new Error('No URL in response');
        }
      } catch (e) {
        console.error(e);
        msg.textContent = 'Failed to open billing portal.';
      }
    });
    // Sign out
    document.getElementById('ua-signout').addEventListener('click', async () => {
      await firebase.auth().signOut();
      window.location.href = '/login/';
    });
  </script>
</body>
</html>
